name: Docker Image Build and Push (Go)

on:
    workflow_call:
        inputs:
            image_prefix:
                description: "Container registry prefix (e.g., ghcr.io)"
                required: true
                type: string
            org_name:
                description: "Organization name"
                required: true
                type: string
            app_name:
                description: "Application name"
                required: true
                type: string
            build_context:
                description: "Docker build context"
                required: true
                type: string
            build_file:
                description: "Dockerfile"
                required: true
                type: string
            build_args:
                description: "Additional docker build arguments (e.g., '--build-arg KEY1=VALUE1 --build-arg KEY2=VALUE2')"
                required: false
                type: string
                default: ""
            tag_suffix:
              description: "Additional image tag suffix for specific target build naming (e.g., 'linux-amd64')"
              required: false
              type: string
              default: ""
            ecr_repository_name:
                description: "ECR repository name. If provided, image will be pushed to both GHCR and ECR (requires AWS_ROLE_ARN, AWS_REGION, AWS_ACCOUNT_ID org vars)"
                required: false
                type: string
        secrets:
            APP_ID:
                required: true
                description: "GitHub App ID to download AOH go modules"
            APP_PRIVATE_KEY:
                required: true
                description: "GitHub App Private Key to download AOH go modules"
        outputs:
            image_tag:
                description: "The full image tag that was built and pushed"
                value: ${{ jobs.build-and-push.outputs.image_tag }}

jobs:
    build-and-push:
        name: "Build & Publish Image"
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
            id-token: write  # Required for AWS OIDC authentication
        outputs:
            image_tag: ${{ steps.build_and_upload.outputs.image_tag }}
        steps:
            - name: "Generate GitHub App Token"
              uses: actions/create-github-app-token@v1
              id: app-token
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.APP_PRIVATE_KEY }}
                  owner: ${{ inputs.org_name }}

            - name: "‚òÅÔ∏è Checkout code"
              uses: actions/checkout@v4
              with:
                  path: ./src

            - name: "Log in to the Container registry"
              uses: docker/login-action@v3
              with:
                  registry: ${{ inputs.image_prefix }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: "üì¶ ${{ inputs.app_name }} - Build and upload container image"
              id: build_and_upload
              run: |
                  cd ./src

                  if [[ "${{ github.ref }}" == "refs/tags/"* || "${{ github.event_name }}" == "release" ]]; then
                    git_hash=$(git rev-parse --short "$GITHUB_SHA")
                    TAG="${GITHUB_REF##*/}"
                  else
                    git_hash=$(git rev-parse --short "$GITHUB_SHA")
                    TAG="${GITHUB_REF##*/}-${git_hash}"
                  fi

                  # Add tag suffix if provided
                  if [[ -n "${{ inputs.tag_suffix }}" ]]; then
                    TAG="${TAG}-${{ inputs.tag_suffix }}"
                  fi

                  BASE_IMAGE_TAG="${{ inputs.image_prefix }}/${{ inputs.org_name }}/${{ inputs.app_name }}"
                  IMAGE_TAG="${BASE_IMAGE_TAG}:${TAG}"
                  echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
                  echo "tag=${TAG}" >> $GITHUB_OUTPUT

                  export IMAGE_TAG=${IMAGE_TAG}
                  docker build --build-arg GITHUB_USERNAME=x-access-token --build-arg GITHUB_TOKEN=${{ steps.app-token.outputs.token }} --build-arg REVISION=${TAG} ${{ inputs.build_args }} -t ${IMAGE_TAG} -f ${{ inputs.build_file }} ${{ inputs.build_context }}
                  docker push ${IMAGE_TAG}

                  if [[ "${{ github.ref }}" == "refs/tags/"* || "${{ github.event_name }}" == "release" ]]; then
                    ## Extra "latest" Tag
                    docker tag ${IMAGE_TAG} ${BASE_IMAGE_TAG}:latest
                    docker push ${BASE_IMAGE_TAG}:latest
                  else
                    ## Extra "latest-dev" Tag
                    docker tag ${IMAGE_TAG} ${BASE_IMAGE_TAG}:latest-dev
                    docker push ${BASE_IMAGE_TAG}:latest-dev
                  fi

            - name: "üîê Configure AWS credentials"
              if: inputs.ecr_repository_name != ''
              uses: aws-actions/configure-aws-credentials@v5
              with:
                  role-to-assume: ${{ vars.AWS_ROLE_ARN }}
                  aws-region: ${{ vars.AWS_REGION }}

            - name: "üîë Log in to Amazon ECR"
              if: inputs.ecr_repository_name != ''
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: "üì¶ Push to Amazon ECR"
              if: inputs.ecr_repository_name != ''
              run: |
                  TAG="${{ steps.build_and_upload.outputs.tag }}"

                  # GHCR image that was already built
                  GHCR_IMAGE="${{ inputs.image_prefix }}/${{ inputs.org_name }}/${{ inputs.app_name }}:${TAG}"

                  # ECR image paths
                  ECR_REGISTRY="${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com"
                  ECR_BASE_IMAGE="${ECR_REGISTRY}/${{ inputs.ecr_repository_name }}"
                  ECR_IMAGE="${ECR_BASE_IMAGE}:${TAG}"

                  # Tag the GHCR image for ECR
                  docker tag ${GHCR_IMAGE} ${ECR_IMAGE}
                  docker push ${ECR_IMAGE}

                  # Push additional tags
                  if [[ "${{ github.ref }}" == "refs/tags/"* || "${{ github.event_name }}" == "release" ]]; then
                    ## Extra "latest" Tag
                    docker tag ${ECR_IMAGE} ${ECR_BASE_IMAGE}:latest
                    docker push ${ECR_BASE_IMAGE}:latest
                  else
                    ## Extra "latest-dev" Tag
                    docker tag ${ECR_IMAGE} ${ECR_BASE_IMAGE}:latest-dev
                    docker push ${ECR_BASE_IMAGE}:latest-dev
                  fi

                  echo "‚úÖ Successfully pushed to ECR: ${ECR_IMAGE}"
